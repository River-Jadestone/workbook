<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 관리자 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        /* 부드러운 화면 전환 효과 */
        .view {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* 삭제 확인 모달 창 스타일 */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        /* 완료된 체크리스트 스타일 */
        .detail-task-item.completed {
            text-decoration: line-through;
            color: #6b7280;
        }
        .detail-task-item.completed .checkbox-icon {
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- 1. 워크북 선택 화면 -->
        <div id="workbook-selection-view" class="view" style="display: block;">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black text-[#2c3e50]">🚀 전체 워크북 목록</h1>
                <p class="text-lg text-[#34495e] mt-2 font-bold">확인하고 싶은 워크북을 선택하세요.</p>
            </header>
            <main id="workbook-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 자바스크립트로 워크북 목록이 여기에 채워집니다. -->
            </main>
        </div>

        <!-- 2. 학생 목록 화면 -->
        <div id="student-list-view" class="view">
            <header class="relative flex items-center justify-center mb-10 py-4">
                <button id="back-to-selection-btn" class="absolute left-0 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    &larr; 목록으로
                </button>
                <h1 id="list-title" class="text-2xl md:text-4xl font-black text-[#2c3e50] text-center"></h1>
            </header>
            <main class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">총 참여 학생 수</h2>
                        <p id="totalStudents" class="text-5xl font-extrabold text-[#3498db]">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">전체 평균 진행률</h2>
                        <p id="averageProgress" class="text-5xl font-extrabold text-[#4ECDC4]">0%</p>
                    </div>
                </div>
                <div id="studentListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 자바스크립트로 학생 카드 목록이 여기에 채워집니다. -->
                </div>
            </main>
        </div>

        <!-- 3. 학생 상세 정보 화면 -->
        <div id="single-student-view" class="view">
             <header class="relative flex items-center justify-center mb-10 py-4">
                <button id="back-to-list-btn" class="absolute left-0 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    &larr; 학생 목록으로
                </button>
                <h1 id="detail-student-name" class="text-2xl md:text-4xl font-black text-[#2c3e50] text-center"></h1>
            </header>
            <main id="student-detail-content" class="space-y-8 max-w-4xl mx-auto">
                 <!-- 학생 상세 정보가 여기에 채워집니다. -->
            </main>
        </div>
    </div>

    <!-- 삭제 확인 모달 창 -->
    <div id="delete-confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">정말 삭제하시겠습니까?</h2>
            <p id="delete-confirmation-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors">취소</button>
                <button id="confirm-delete-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition-colors">삭제</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvLt0F8gSqe24Gf0xHHw25MfMirmV6er0",
            authDomain: "workbook-c77c1.firebaseapp.com",
            projectId: "workbook-c77c1",
            storageBucket: "workbook-c77c1.appspot.com",
            messagingSenderId: "763395615278",
            appId: "1:763395615278:web:8f245f9b328440f0a54dbf"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const workbooks = [
            { 
                id: 'snack-shop-workbook', 
                name: '🌈 알록달록 스낵 가게 만들기',
                checklistItems: [
                    "스낵 가게 로봇을 뚝딱뚝딱 조립했어요.",
                    "내 가게의 규칙을 정하고 코딩 약속을 했어요.",
                    "색깔에 맞춰 과자를 주는 기본 코딩을 완성했어요.",
                    "더 멋진 기능을 만드는 도전 미션에 성공했어요!",
                    "AI 친구와 함께 재미있는 이야기를 만들었어요.",
                    "친구들에게 내 스낵 가게를 멋지게 자랑했어요."
                ]
            },
        ];
        
        const workbookSelectionView = document.getElementById('workbook-selection-view');
        const studentListView = document.getElementById('student-list-view');
        const singleStudentView = document.getElementById('single-student-view');
        const workbookListContainer = document.getElementById('workbook-list');
        const studentListContainer = document.getElementById('studentListContainer');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const listTitle = document.getElementById('list-title');
        const detailStudentName = document.getElementById('detail-student-name');
        const studentDetailContent = document.getElementById('student-detail-content');
        const totalStudentsEl = document.getElementById('totalStudents');
        const averageProgressEl = document.getElementById('averageProgress');
        const deleteModal = document.getElementById('delete-confirmation-modal');
        const deleteConfirmationText = document.getElementById('delete-confirmation-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let currentSnapshotUnsubscribe = null;
        let currentWorkbook = null; 
        let studentIdToDelete = null;

        const showView = (viewToShow) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            viewToShow.style.display = 'block';
        };

        const showStudentDetails = (workbook) => {
            currentWorkbook = workbook;
            showView(studentListView);
            listTitle.textContent = workbook.name;
            studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">학생 데이터를 불러오는 중입니다...</p>';
            totalStudentsEl.textContent = '0';
            averageProgressEl.textContent = '0%';

            const studentsColRef = collection(db, `artifacts/${workbook.id}/public/data/students`);
            
            if (currentSnapshotUnsubscribe) currentSnapshotUnsubscribe();
            currentSnapshotUnsubscribe = onSnapshot(studentsColRef, (snapshot) => {
                const studentsData = [];
                snapshot.forEach((doc) => studentsData.push([doc.id, doc.data()]));
                updateDashboard(studentsData);
            }, (error) => {
                console.error(`Error fetching data for ${workbook.id}:`, error);
                studentListContainer.innerHTML = `<p class="text-center md:col-span-2 lg:col-span-3 text-red-500">"${workbook.name}" 워크북 데이터를 불러오는 중 오류가 발생했습니다.</p>`;
            });
        };

        const createStudentCard = (studentId, studentData) => {
            const studentName = studentData.studentName || '이름 없음';
            const totalTasks = currentWorkbook.checklistItems.length;
            const completedCount = (studentData.completedTasks || []).filter(Boolean).length;
            const progress = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;

            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg p-6 flex flex-col justify-between cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all";
            card.dataset.studentId = studentId;

            card.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-xl text-[#2c3e50] truncate">${studentName}</h3>
                        <p class="text-sm text-gray-400">ID: ${studentId.substring(0, 8)}...</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-600">진행률: ${Math.round(progress)}%</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                            <div class="bg-gradient-to-r from-[#3498db] to-[#4ECDC4] h-4 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
                <button data-id="${studentId}" data-name="${studentName}" class="delete-btn mt-6 w-full bg-red-100 text-red-700 font-bold py-2 px-3 rounded-lg hover:bg-red-200 transition-colors">삭제</button>
            `;
            return card;
        };
        
        const updateDashboard = (students) => {
            studentListContainer.innerHTML = '';
            let totalProgress = 0;
            
            if (students.length === 0) {
                studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">아직 참여한 학생이 없습니다.</p>';
            }

            students.sort((a, b) => (a[1].studentName || '').localeCompare(b[1].studentName || '', 'ko'));

            const studentDataMap = new Map(students);
            
            studentDataMap.forEach((data, id) => {
                const card = createStudentCard(id, data);
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                       showSingleStudentDetail(data);
                    }
                });
                studentListContainer.appendChild(card);
                
                const totalTasks = currentWorkbook.checklistItems.length;
                const completedCount = (data.completedTasks || []).filter(Boolean).length;
                totalProgress += totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            });
            
            totalStudentsEl.textContent = students.length;
            const avgProgress = students.length > 0 ? totalProgress / students.length : 0;
            averageProgressEl.textContent = `${Math.round(avgProgress)}%`;
        };

        const showSingleStudentDetail = (studentData) => {
            detailStudentName.textContent = studentData.studentName || '이름 없음';
            
            let checklistHTML = '';
            currentWorkbook.checklistItems.forEach((itemText, index) => {
                const isCompleted = studentData.completedTasks?.[index] || false;
                checklistHTML += `
                    <li class="detail-task-item flex items-center p-3 bg-slate-100 rounded-lg ${isCompleted ? 'completed' : ''}">
                        <div class="checkbox-icon w-6 h-6 mr-4 flex-shrink-0 flex items-center justify-center font-bold">${isCompleted ? '✔' : '✖'}</div>
                        <span>${itemText}</span>
                    </li>
                `;
            });
            
            const story = (studentData.savedStory || '아직 이야기가 없어요.').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought1 = (studentData.savedThoughts?.[0] || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought2 = (studentData.savedThoughts?.[1] || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

            studentDetailContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">✅ 활동 체크리스트</h2>
                    <ul class="space-y-3">${checklistHTML}</ul>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">🚀 AI 친구가 만든 이야기</h2>
                    <div class="p-4 bg-gray-100 rounded-md min-h-[100px] whitespace-pre-wrap">${story}</div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">🤔 생각 나누기</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-1">오늘 내가 만든 스낵 가게 로봇의 최고로 멋진 점은 무엇인가요?</h3>
                            <p class="p-3 bg-gray-100 rounded-md min-h-[60px]">${thought1 || '아직 작성하지 않았어요.'}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-1">이 멋진 로봇이 우리 집이나 학교에 있다면, 무엇을 도와줄 수 있을까요?</h3>
                            <p class="p-3 bg-gray-100 rounded-md min-h-[60px]">${thought2 || '아직 작성하지 않았어요.'}</p>
                        </div>
                    </div>
                </div>
            `;
            showView(singleStudentView);
        };
        
        const openDeleteModal = (studentId, studentName) => {
            studentIdToDelete = studentId;
            deleteConfirmationText.textContent = `'${studentName}' 학생의 모든 데이터가 영구적으로 삭제됩니다. 이 작업은 되돌릴 수 없습니다.`;
            deleteModal.classList.remove('hidden');
        };

        const closeDeleteModal = () => {
            studentIdToDelete = null;
            deleteModal.classList.add('hidden');
        };

        // --- 초기화 및 이벤트 리스너 ---
        
        workbookListContainer.innerHTML = '';
        workbooks.forEach(wb => {
            const wbCard = document.createElement('div');
            wbCard.className = "bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300";
            wbCard.innerHTML = `<h2 class="text-2xl font-bold text-[#2c3e50]">${wb.name}</h2>`;
            wbCard.addEventListener('click', () => showStudentDetails(wb));
            workbookListContainer.appendChild(wbCard);
        });
        
        backToSelectionBtn.addEventListener('click', () => showView(workbookSelectionView));
        backToListBtn.addEventListener('click', () => showView(studentListView));

        studentListContainer.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const studentId = deleteButton.dataset.id;
                const studentName = deleteButton.dataset.name;
                openDeleteModal(studentId, studentName);
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            if (studentIdToDelete && currentWorkbook) {
                const docRef = doc(db, `artifacts/${currentWorkbook.id}/public/data/students`, studentIdToDelete);
                try {
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("데이터 삭제 중 오류가 발생했습니다.");
                } finally {
                    closeDeleteModal();
                }
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
            }
        });

    </script>
</body>
</html>
