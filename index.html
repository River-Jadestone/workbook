<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        /* ë¶€ë“œëŸ¬ìš´ í™”ë©´ ì „í™˜ íš¨ê³¼ */
        .view {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- ì›Œí¬ë¶ ì„ íƒ í™”ë©´ -->
        <div id="workbook-selection-view" class="view" style="display: block;">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black text-[#2c3e50]">ğŸš€ ì „ì²´ ì›Œí¬ë¶ ëª©ë¡</h1>
                <p class="text-lg text-[#34495e] mt-2 font-bold">í™•ì¸í•˜ê³  ì‹¶ì€ ì›Œí¬ë¶ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            </header>
            <main id="workbook-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›Œí¬ë¶ ëª©ë¡ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </main>
        </div>

        <!-- í•™ìƒ í˜„í™© ìƒì„¸ í™”ë©´ -->
        <div id="student-details-view" class="view">
            <!-- [ìˆ˜ì •ë¨] í—¤ë” ë ˆì´ì•„ì›ƒ ë³€ê²½: flexì™€ absoluteë¥¼ ì´ìš©í•´ ë²„íŠ¼ê³¼ ì œëª©ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ìˆ˜ì • -->
            <header class="relative flex items-center justify-center mb-10 py-4">
                <button id="backButton" class="absolute left-0 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    &larr; ë’¤ë¡œ ê°€ê¸°
                </button>
                <h1 id="details-title" class="text-2xl md:text-4xl font-black text-[#2c3e50] text-center"></h1>
            </header>
            <main class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">ì´ ì°¸ì—¬ í•™ìƒ ìˆ˜</h2>
                        <p id="totalStudents" class="text-5xl font-extrabold text-[#3498db]">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">ì „ì²´ í‰ê·  ì§„í–‰ë¥ </h2>
                        <p id="averageProgress" class="text-5xl font-extrabold text-[#4ECDC4]">0%</p>
                    </div>
                </div>
                <div id="studentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í•™ìƒ ì¹´ë“œ ëª©ë¡ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ê¸°ë³¸ ì„¤ì • ---
        // [ìˆ˜ì •ë¨] storageBucket ì£¼ì†Œ í˜•ì‹ì„ í‘œì¤€ì— ë§ê²Œ ë³€ê²½í•˜ê³ , ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” measurementIdë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "AIzaSyAvLt0F8gSqe24Gf0xHHw25MfMirmV6er0",
            authDomain: "workbook-c77c1.firebaseapp.com",
            projectId: "workbook-c77c1",
            storageBucket: "workbook-c77c1.firebasestorage.app",
            messagingSenderId: "763395615278",
            appId: "1:763395615278:web:8f245f9b328440f0a54dbf",
            measurementId: "G-M1GP1JRRVV"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ===================================================================================
        // ** ì¤‘ìš”! **
        // ìƒˆë¡œìš´ ì›Œí¬ë¶ì„ ë§Œë“¤ ë•Œë§ˆë‹¤ ì•„ë˜ workbooks ë°°ì—´ì— ì •ë³´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.
        // id: ì›Œí¬ë¶ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì— ìˆëŠ” appId ê°’ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.
        // name: ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  ì›Œí¬ë¶ì˜ ì´ë¦„ì…ë‹ˆë‹¤.
        // ===================================================================================
        const workbooks = [
            { id: 'snack-shop-workbook', name: 'ğŸŒˆ ì•Œë¡ë‹¬ë¡ ìŠ¤ë‚µ ê°€ê²Œ ë§Œë“¤ê¸°' },
            // ì˜ˆì‹œ: { id: 'smart-pot-workbook', name: 'ğŸŒ± ë˜‘ë˜‘í•œ ìŠ¤ë§ˆíŠ¸ í™”ë¶„' },
            // ì˜ˆì‹œ: { id: 'weather-station', name: 'â˜€ï¸ ìš°ë¦¬ ë™ë„¤ ë‚ ì”¨ ê´€ì¸¡ì†Œ' },
        ];
        
        // --- UI ìš”ì†Œ ë³€ìˆ˜ ---
        const workbookSelectionView = document.getElementById('workbook-selection-view');
        const studentDetailsView = document.getElementById('student-details-view');
        const workbookListContainer = document.getElementById('workbook-list');
        const studentListContainer = document.getElementById('studentList');
        const backButton = document.getElementById('backButton');
        const detailsTitle = document.getElementById('details-title');
        const totalStudentsEl = document.getElementById('totalStudents');
        const averageProgressEl = document.getElementById('averageProgress');
        let currentSnapshotUnsubscribe = null; // ì‹¤ì‹œê°„ ê°ì‹œë¥¼ ë©ˆì¶”ê¸° ìœ„í•œ ë³€ìˆ˜

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        /**
         * ì›Œí¬ë¶ ëª©ë¡ í™”ë©´ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         */
        const showWorkbookSelection = () => {
            workbookSelectionView.style.display = 'block';
            studentDetailsView.style.display = 'none';
            // ì´ì „ì— ì‹¤í–‰ ì¤‘ì´ë˜ ì‹¤ì‹œê°„ ê°ì‹œê°€ ìˆë‹¤ë©´ ì¤‘ì§€
            if (currentSnapshotUnsubscribe) {
                currentSnapshotUnsubscribe();
                currentSnapshotUnsubscribe = null;
            }
        };

        /**
         * íŠ¹ì • ì›Œí¬ë¶ì˜ í•™ìƒ í˜„í™© í™”ë©´ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         * @param {object} workbook - {id, name} ì›Œí¬ë¶ ì •ë³´ ê°ì²´
         */
        const showStudentDetails = (workbook) => {
            workbookSelectionView.style.display = 'none';
            studentDetailsView.style.display = 'block';
            detailsTitle.textContent = workbook.name;
            studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            totalStudentsEl.textContent = '0';
            averageProgressEl.textContent = '0%';

            // ì„ íƒëœ ì›Œí¬ë¶ì˜ í•™ìƒ ë°ì´í„° ê²½ë¡œ ì„¤ì •
            const studentsColRef = collection(db, `artifacts/${workbook.id}/public/data/students`);
            
            // ì‹¤ì‹œê°„ìœ¼ë¡œ í•™ìƒ ë°ì´í„° ê°ì‹œ ì‹œì‘
            currentSnapshotUnsubscribe = onSnapshot(studentsColRef, (snapshot) => {
                const studentsData = [];
                snapshot.forEach((doc) => {
                    studentsData.push([doc.id, doc.data()]);
                });
                updateDashboard(studentsData);
            }, (error) => {
                console.error(`Error fetching data for ${workbook.id}:`, error);
                studentListContainer.innerHTML = `<p class="text-center md:col-span-2 lg:col-span-3 text-red-500">"${workbook.name}" ì›Œí¬ë¶ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
            });
        };

        /**
         * í•™ìƒ ì¹´ë“œ HTMLì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
         */
        const createStudentCard = (studentId, studentData) => {
            const studentName = studentData.studentName || 'ì´ë¦„ ì—†ìŒ';
            const studentIdShort = studentId.substring(0, 8);
            
            const completedTasks = studentData.completedTasks || [];
            const totalTasks = 7; // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ê°œìˆ˜ë¥¼ ê³ ì •ê°’ìœ¼ë¡œ ì„¤ì •
            const completedCount = completedTasks.filter(Boolean).length;
            const progress = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            
            const story = (studentData.savedStory || 'ì•„ì§ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”.').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought1 = (studentData.savedThoughts?.[0] || 'ì•„ì§ ìƒê°ì´ ì—†ì–´ìš”.').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought2 = (studentData.savedThoughts?.[1] || 'ì•„ì§ ìƒê°ì´ ì—†ì–´ìš”.').replace(/</g, "&lt;").replace(/>/g, "&gt;");

            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg p-6 space-y-4";
            card.innerHTML = `
                <div>
                    <h3 class="font-bold text-xl text-[#2c3e50] truncate" title="${studentId}">${studentName}</h3>
                    <p class="text-sm text-gray-400">ID: ${studentIdShort}...</p>
                </div>
                <div>
                    <p class="font-semibold text-gray-600">ì§„í–‰ë¥ : ${Math.round(progress)}%</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                        <div class="bg-gradient-to-r from-[#3498db] to-[#4ECDC4] h-4 rounded-full" style="width: ${progress}%"></div>
                    </div>
                </div>
                 <div class="space-y-2">
                    <div>
                        <h4 class="font-bold text-gray-700">ğŸ¤– AI ì¹œêµ¬ ì´ì•¼ê¸°:</h4>
                        <p class="text-sm bg-gray-100 p-2 rounded-md max-h-24 overflow-y-auto">${story}</p>
                    </div>
                </div>
            `;
            return card;
        };
        
        /**
         * í•™ìƒ ë°ì´í„°ë¥¼ ë°›ì•„ ëŒ€ì‹œë³´ë“œ í™”ë©´ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
         */
        const updateDashboard = (students) => {
            studentListContainer.innerHTML = '';
            let totalProgress = 0;
            
            if (students.length === 0) {
                studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">ì•„ì§ ì°¸ì—¬í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            // í•™ìƒ ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬
            students.sort((a, b) => (a[1].studentName || '').localeCompare(b[1].studentName || '', 'ko'));

            students.forEach(([id, data]) => {
                const card = createStudentCard(id, data);
                studentListContainer.appendChild(card);
                
                const completedTasks = data.completedTasks || [];
                const totalTasks = 7;
                const completedCount = completedTasks.filter(Boolean).length;
                totalProgress += totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            });
            
            totalStudentsEl.textContent = students.length;
            const avgProgress = students.length > 0 ? totalProgress / students.length : 0;
            averageProgressEl.textContent = `${Math.round(avgProgress)}%`;
        };

        // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        
        // ì›Œí¬ë¶ ëª©ë¡ì„ í™”ë©´ì— ê·¸ë¦¼
        workbookListContainer.innerHTML = '';
        workbooks.forEach(wb => {
            const wbCard = document.createElement('div');
            wbCard.className = "bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300";
            wbCard.innerHTML = `<h2 class="text-2xl font-bold text-[#2c3e50]">${wb.name}</h2>`;
            wbCard.addEventListener('click', () => showStudentDetails(wb));
            workbookListContainer.appendChild(wbCard);
        });
        
        // ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        backButton.addEventListener('click', showWorkbookSelection);
        
        // Firebase ì¸ì¦
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

    </script>
</body>
</html>
