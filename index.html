<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì›Œí¬ë¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f4f8; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #3498db; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view { display: none; }
        .view.active { display: block; }
        .workbook-section { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        
        /* ìŠ¬ë¼ì´ë“œì‡¼ ìŠ¤íƒ€ì¼ */
        .slider-container { position: relative; max-width: 100%; margin: auto; }
        .slide { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0.4 } to { opacity: 1 } }
        .slide img, .slide iframe { width: 100%; aspect-ratio: 16 / 9; object-fit: contain; border-radius: 0.75rem; background-color: #e5e7eb; }
        .slider-nav { cursor: pointer; position: absolute; top: 50%; width: auto; padding: 16px; margin-top: -22px; color: white; font-weight: bold; font-size: 24px; transition: 0.6s ease; border-radius: 0 3px 3px 0; user-select: none; background-color: rgba(0,0,0,0.3); }
        .prev { left: 0; border-radius: 3px 0 0 3px; }
        .next { right: 0; border-radius: 0 3px 3px 0; }
        .slider-nav:hover { background-color: rgba(0,0,0,0.8); }
        .caption-text { color: #4b5563; font-size: 1rem; padding: 8px 12px; text-align: center; }
        .dots-container { text-align: center; padding: 10px 0; }
        .dot { cursor: pointer; height: 15px; width: 15px; margin: 0 2px; background-color: #bbb; border-radius: 50%; display: inline-block; transition: background-color 0.6s ease; }
        .dot.active { background-color: #717171; }

        /* ì»¤ìŠ¤í…€ í™•ì¸ ì°½ ìŠ¤íƒ€ì¼ */
        .custom-confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .custom-confirm-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); max-width: 90%; width: 400px; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex-col items-center justify-center">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-2 font-bold text-lg">ì›Œí¬ë¶ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- [ì‹ ê·œ] ì»¤ìŠ¤í…€ í™•ì¸ ì°½ -->
    <div id="custom-confirm" class="custom-confirm-overlay hidden">
        <div class="custom-confirm-box">
            <h3 class="text-xl font-bold mb-4">ì´ë¯¸ ì œì¶œí•œ ì›Œí¬ë¶ì…ë‹ˆë‹¤.</h3>
            <p class="mb-6">ì–´ë–»ê²Œ í• ê¹Œìš”?</p>
            <div class="flex justify-around">
                <button id="confirm-review-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition-colors">ğŸ“– ë³µìŠµí•˜ê¸°</button>
                <button id="confirm-restart-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">âœ¨ ìƒˆë¡œ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div id="start-view" class="view active">
            <header class="text-center mb-10"><h1 class="text-4xl md:text-5xl font-black text-gray-800">ğŸš€ ìŠ¤ë§ˆíŠ¸ ì›Œí¬ë¶</h1><p class="text-lg text-gray-600 mt-2">1. ì´ë¦„ì„ ì…ë ¥í•˜ê³ , 2. í™œë™í•  êµêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p></header>
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <label for="studentName" class="block font-bold text-xl text-gray-700 mb-2">ğŸ‘‹ ë‚´ ì´ë¦„ì€?</label>
                <input type="text" id="studentName" placeholder="ì—¬ê¸°ì— ì´ë¦„ì„ ê¼­ ì ì–´ì£¼ì„¸ìš”..." class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                <p id="name-error" class="text-red-500 text-sm mt-1 hidden">ì´ë¦„ì„ ì…ë ¥í•´ì•¼ êµêµ¬ë¥¼ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”!</p>
            </div>
            <div id="tool-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
        <div id="workbook-list-view" class="view">
            <header class="text-center mb-10"><button id="back-to-start-btn" class="float-left bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">â† êµêµ¬ ë‹¤ì‹œ ì„ íƒ</button><h1 id="workbook-list-title" class="text-3xl md:text-4xl font-black text-gray-800">ì›Œí¬ë¶ì„ ì„ íƒí•˜ì„¸ìš”</h1></header>
            <div id="workbook-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8"></div>
        </div>
        <div id="workbook-view" class="view"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        const loadingOverlay = document.getElementById('loading-overlay'), loadingText = document.getElementById('loading-text');
        const startView = document.getElementById('start-view'), workbookListView = document.getElementById('workbook-list-view'), workbookView = document.getElementById('workbook-view');
        const studentNameInput = document.getElementById('studentName'), nameError = document.getElementById('name-error');
        const backToStartBtn = document.getElementById('back-to-start-btn');
        const toolListContainer = document.getElementById('tool-list'), workbookListContainer = document.getElementById('workbook-list'), workbookListTitle = document.getElementById('workbook-list-title');
        const customConfirm = document.getElementById('custom-confirm');

        let allWorkbooks = [], geminiApiKey = null, currentTool = '', currentWorkbook = null, slideIndex = 1;

        // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---
        function showLoading(show, message = 'ì²˜ë¦¬ ì¤‘...') { loadingText.textContent = message; loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function switchView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); window.scrollTo(0, 0); }
        function getStorageKey() { if (!studentNameInput.value.trim() || !currentWorkbook) return null; return `smart-workbook-${studentNameInput.value.trim()}-${currentWorkbook.id}`; }
        
        function saveStateToLocalStorage(isSubmitted = false) {
            const key = getStorageKey(); if (!key) return;
            const state = {};
            document.querySelectorAll('#workbook-view [data-save]').forEach(el => { state[el.id] = el.type === 'checkbox' ? el.checked : (el.value !== undefined ? el.value : el.innerHTML); });
            const tasks = document.querySelectorAll('.task-item');
            if (tasks.length > 0) { state.tasks = Array.from(tasks).map(item => item.classList.contains('completed')); }
            state.submitted = isSubmitted; // [ìˆ˜ì •ë¨] ì œì¶œ ìƒíƒœ í”Œë˜ê·¸ ì¶”ê°€
            localStorage.setItem(key, JSON.stringify(state));
        }

        function loadStateFromLocalStorage(isReviewMode = false) {
            const key = getStorageKey(); if (!key) return;
            const savedState = localStorage.getItem(key);
            if (savedState) {
                const state = JSON.parse(savedState);
                Object.keys(state).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') { el.value = state[id]; } 
                        else { el.innerHTML = state[id]; }
                    }
                });
                if (state.tasks) {
                    document.querySelectorAll('.task-item').forEach((item, index) => {
                        if (state.tasks[index]) {
                            item.classList.add('completed');
                            const checkbox = item.querySelector('.checkbox');
                            checkbox.style.backgroundColor = '#34d399'; checkbox.style.borderColor = '#34d399';
                        }
                    });
                }
                // [ì‹ ê·œ] ë³µìŠµ ëª¨ë“œì¼ ê²½ìš° ëª¨ë“  ì…ë ¥ ë¹„í™œì„±í™”
                if (isReviewMode) {
                    document.querySelectorAll('#workbook-view textarea, #workbook-view input, #workbook-view button, .task-item').forEach(el => {
                        el.disabled = true;
                        if(el.classList.contains('task-item')) el.style.cursor = 'default';
                    });
                    document.getElementById('back-to-list-btn').disabled = false; // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì€ í™œì„±í™”
                }
            }
        }

        function handleFinalSubmit() {
            showLoading(true, 'ìµœì¢… ê²°ê³¼ë¥¼ ì„ ìƒë‹˜ê»˜ ë³´ë‚´ëŠ” ì¤‘...');
            const recordData = {
                studentName: studentNameInput.value.trim(), tool: currentTool, workbookId: currentWorkbook.id, workbookName: currentWorkbook.name,
                activityContent: getActivityContent(), aiStory: document.getElementById('storyResult')?.textContent || ''
            };
            google.script.run.withSuccessHandler(response => {
                showLoading(false); alert('ì›Œí¬ë¶ í™œë™ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆì–´ìš”!');
                saveStateToLocalStorage(true); // [ìˆ˜ì •ë¨] ì‚­ì œ ëŒ€ì‹  'ì œì¶œ ì™„ë£Œ' ìƒíƒœë¡œ ì €ì¥
                switchView('start-view');
            }).withFailureHandler(err => { showLoading(false); alert('ì œì¶œ ì‹¤íŒ¨: ' + err.message); }).saveRecord(recordData);
        }

        function getActivityContent() {
            const content = JSON.parse(currentWorkbook.content);
            const activityContent = {};
            const tasks = document.querySelectorAll('.task-item');
            if (tasks.length > 0) { activityContent.tasks = Array.from(tasks).map(item => item.classList.contains('completed')); }
            if (content.type === 'bricq-hybrid') {
                activityContent.quizzes = Array.from(document.querySelectorAll('textarea[id^="quiz"]')).map(area => area.value);
                const spikeIdeaEl = document.getElementById('spike-idea');
                activityContent.spikeIdea = spikeIdeaEl ? spikeIdeaEl.value : '';
            } else {
                activityContent.thoughts = Array.from(document.querySelectorAll('textarea[id^="thought"]')).map(area => area.value);
            }
            return activityContent;
        }
        function plusSlides(n) { showSlide(slideIndex += n); }
        function currentSlide(n) { showSlide(slideIndex = n); }
        function showSlide(n) {
            let i; let slides = document.getElementsByClassName("slide"); let dots = document.getElementsByClassName("dot");
            if (n > slides.length) {slideIndex = 1}
            if (n < 1) {slideIndex = slides.length}
            for (i = 0; i < slides.length; i++) { slides[i].style.display = "none"; }
            for (i = 0; i < dots.length; i++) { dots[i].className = dots[i].className.replace(" active", ""); }
            if (slides.length > 0) { slides[slideIndex-1].style.display = "block"; dots[slideIndex-1].className += " active"; }
        }
        function displayStartScreen() {
            const tools = [...new Set(allWorkbooks.map(wb => wb.tool))];
            toolListContainer.innerHTML = '';
            tools.forEach(tool => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-lg p-8 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer text-center";
                card.innerHTML = `<h3 class="text-2xl font-bold text-blue-600">${tool}</h3>`;
                card.onclick = () => selectTool(tool);
                toolListContainer.appendChild(card);
            });
            switchView('start-view');
        }
        function selectTool(toolName) {
            if (!studentNameInput.value.trim()) { nameError.classList.remove('hidden'); studentNameInput.focus(); return; }
            nameError.classList.add('hidden'); showWorkbooksForTool(toolName);
        }
        function showWorkbooksForTool(toolName) {
            currentTool = toolName; workbookListTitle.textContent = `ğŸš€ ${toolName} ì›Œí¬ë¶`;
            const filteredWorkbooks = allWorkbooks.filter(wb => wb.tool === toolName);
            workbookListContainer.innerHTML = '';
            filteredWorkbooks.forEach(wb => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer";
                card.innerHTML = `<h3 class="text-2xl font-bold text-gray-800">${wb.name}</h3><p class="text-gray-600 mt-2">${wb.description}</p>`;
                card.onclick = () => startWorkbook(wb);
                workbookListContainer.appendChild(card);
            });
            switchView('workbook-list-view');
        }
        
        // [ìˆ˜ì •ë¨] ì›Œí¬ë¶ ì‹œì‘ ì‹œ ì œì¶œ ì—¬ë¶€ í™•ì¸
        function startWorkbook(workbookData) {
            currentWorkbook = workbookData;
            const key = getStorageKey();
            const savedState = localStorage.getItem(key);
            if (savedState && JSON.parse(savedState).submitted) {
                showCustomConfirm(() => { // ë³µìŠµí•˜ê¸°
                    buildAndLoadWorkbook(workbookData, true);
                }, () => { // ìƒˆë¡œ ì‹œì‘
                    localStorage.removeItem(key);
                    buildAndLoadWorkbook(workbookData, false);
                });
            } else { // ì²˜ìŒ ì‹œì‘í•˜ê±°ë‚˜, ì¤‘ê°„ ì €ì¥ëœ ë‚´ìš©ì´ ìˆì„ ë•Œ
                buildAndLoadWorkbook(workbookData, false);
            }
        }

        function buildAndLoadWorkbook(workbookData, isReview) {
            if (buildWorkbookView(workbookData, isReview)) {
                switchView('workbook-view');
                loadStateFromLocalStorage(isReview);
            }
        }

        function showCustomConfirm(onReview, onRestart) {
            customConfirm.classList.remove('hidden');
            document.getElementById('confirm-review-btn').onclick = () => { customConfirm.classList.add('hidden'); onReview(); };
            document.getElementById('confirm-restart-btn').onclick = () => { customConfirm.classList.add('hidden'); onRestart(); };
        }
        
        function buildWorkbookView(workbook, isReviewMode = false) {
            try {
                const content = JSON.parse(workbook.content);
                let contentHtml = `<header class="text-center mb-10"><h1 class="text-4xl md:text-5xl font-black text-gray-800">${workbook.name}</h1><p class="text-lg text-gray-600 mt-2">${workbook.description}</p></header><main class="space-y-8">`;

                if (content.introMedia && Array.isArray(content.introMedia) && content.introMedia.length > 0) {
                    contentHtml += `<div class="slider-container workbook-section">`;
                    content.introMedia.forEach(media => {
                        contentHtml += `<div class="slide">`;
                        if (media.type === 'image') { contentHtml += `<img src="${media.url}" alt="${media.caption || 'ì›Œí¬ë¶ ì´ë¯¸ì§€'}">`; } 
                        else if (media.type === 'video') { contentHtml += `<iframe src="${media.url}" class="w-full" style="aspect-ratio: 16/9;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`; }
                        if (media.caption) { contentHtml += `<div class="caption-text">${media.caption}</div>`; }
                        contentHtml += `</div>`;
                    });
                    if (content.introMedia.length > 1) {
                        contentHtml += `<a class="prev slider-nav" onclick="plusSlides(-1)">&#10094;</a><a class="next slider-nav" onclick="plusSlides(1)">&#10095;</a>`;
                        contentHtml += `</div><div class="dots-container">`;
                        content.introMedia.forEach((_, i) => { contentHtml += `<span class="dot" onclick="currentSlide(${i + 1})"></span>`; });
                        contentHtml += `</div>`;
                    } else { contentHtml += `</div>`; }
                }

                const keywords = (content.aiKeywords && Array.isArray(content.aiKeywords) && content.aiKeywords.length >= 3) ? content.aiKeywords : ['ë¡œë´‡', 'ìƒ‰ê¹”', 'ì†ë‹˜'];
                const aiStorySectionHtml = `<div class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸš€ AI ì¹œêµ¬ë‘ ì´ì•¼ê¸° ë§Œë“¤ê¸°</h2><p class="text-gray-600 mb-4">ì˜¤ëŠ˜ ë§Œë“  ëª¨ë¸ì— ëŒ€í•œ ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ìƒìƒí•´ë´ìš”!</p><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><input id="keyword1" data-save type="text" placeholder="ë‹¨ì–´ 1 (ì˜ˆ: ${keywords[0]})" class="p-2 border rounded-md"><input id="keyword2" data-save type="text" placeholder="ë‹¨ì–´ 2 (ì˜ˆ: ${keywords[1]})" class="p-2 border rounded-md"><input id="keyword3" data-save type="text" placeholder="ë‹¨ì–´ 3 (ì˜ˆ: ${keywords[2]})" class="p-2 border rounded-md"></div><button id="generateStoryBtn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 flex items-center justify-center"><span id="btnText">ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸° ë§Œë“¤ê¸°!</span><div id="btnSpinner" class="spinner hidden ml-2"></div></button><div id="storyResult" data-save class="mt-4 p-4 bg-gray-100 rounded-md min-h-[100px] whitespace-pre-wrap"></div></div>`;
                if (content.type === 'bricq-hybrid') {
                    contentHtml += `<section class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">â‘  ì˜¤ëŠ˜ì˜ ì‹¤í—˜: ${content.mainQuestion}</h2></section><section class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">â‘¡ í•µì‹¬ ê°œë…</h2>${content.keyConcepts.map(c => `<div class="mb-2"><strong class="text-blue-600">${c.term}:</strong> ${c.description}</div>`).join('')}</section><section class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">â‘¢ í™œë™ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2><ul id="task-list" class="space-y-3">${content.tasks.map(task => `<li class="task-item flex items-center p-3 bg-slate-100 rounded-lg cursor-pointer"><div class="checkbox w-6 h-6 border-2 border-gray-300 rounded-md mr-4"></div><span>${task}</span></li>`).join('')}</ul></section><section class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">â‘£ ê²°ê³¼ ë¶„ì„ ë° í€´ì¦ˆ</h2>${content.quizzes.map((q, i) => `<div class="mb-4"><label for="quiz${i}" class="block font-semibold mb-1">${q.question}</label><textarea id="quiz${i}" data-save rows="3" class="w-full p-2 border rounded-md"></textarea></div>`).join('')}</section>${aiStorySectionHtml}`;
                    if(content.spikeExtension) { contentHtml += `<section class="workbook-section border-4 border-dashed border-blue-400"><h2 class="text-2xl font-bold text-blue-700 mb-4">${content.spikeExtension.title}</h2><p class="mb-4">${content.spikeExtension.mission}</p><p class="mb-2"><strong>í•„ìš” ë¶€í’ˆ:</strong> ${content.spikeExtension.requiredParts.join(', ')}</p><div class="mb-4"><label for="spike-idea" class="block font-semibold mb-1">${content.spikeExtension.ideaPrompt}</label><textarea id="spike-idea" data-save rows="3" class="w-full p-2 border rounded-md"></textarea></div></section>`; }
                } else {
                    contentHtml += `<div class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">âœ… ì˜¤ëŠ˜ ë‚´ê°€ í•  ì¼!</h2><ul id="task-list" class="space-y-3">${content.tasks.map(task => `<li class="task-item flex items-center p-3 bg-slate-100 rounded-lg cursor-pointer"><div class="checkbox w-6 h-6 border-2 border-gray-300 rounded-md mr-4"></div><span>${task}</span></li>`).join('')}</ul></div>${aiStorySectionHtml}<div class="workbook-section"><h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ¤” ìƒê° ë‚˜ëˆ„ê¸°</h2><div class="space-y-4">${content.thoughts.map((thought, i) => `<div><label for="thought${i}" class="block font-semibold mb-1">${thought}</label><textarea id="thought${i}" data-save rows="3" class="w-full p-2 border rounded-md"></textarea></div>`).join('')}</div></div>`;
                }
                contentHtml += `<div class="flex justify-between items-center mt-8"><button id="back-to-list-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">â† ì›Œí¬ë¶ ëª©ë¡</button><button id="saveBtn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">ìµœì¢… ì œì¶œí•˜ê¸°</button></div></main>`;
                workbookView.innerHTML = contentHtml;
                addWorkbookEventListeners();
                if (content.introMedia && content.introMedia.length > 0) { slideIndex = 1; showSlide(slideIndex); }
                return true;

            } catch (error) {
                console.error("ì›Œí¬ë¶ ì½˜í…ì¸ (JSON) íŒŒì‹± ì˜¤ë¥˜:", error);
                alert(`'${workbook.name}' ì›Œí¬ë¶ì„ ì—¬ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì›ì¸: ì›Œí¬ë¶ì˜ 'ì½˜í…ì¸ ' ë°ì´í„°(ì„¤ê³„ë„)ì— ì˜¤ë¥˜ê°€ ìˆëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•: êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì›Œí¬ë¶ì˜ 'ì½˜í…ì¸ ' ì…€ ë‚´ìš©ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”. (ì‰¼í‘œ, ë”°ì˜´í‘œ, ê´„í˜¸ ë“±)`);
                switchView('workbook-list-view'); 
                return false;
            }
        }

        function addWorkbookEventListeners() {
            document.querySelectorAll('#workbook-view [data-save]').forEach(el => el.addEventListener('input', saveStateToLocalStorage));
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.classList.toggle('completed');
                    const checkbox = item.querySelector('.checkbox');
                    checkbox.style.backgroundColor = item.classList.contains('completed') ? '#34d399' : 'transparent';
                    checkbox.style.borderColor = item.classList.contains('completed') ? '#34d399' : '#d1d5db';
                    saveStateToLocalStorage();
                });
            });
            const generateBtn = document.getElementById('generateStoryBtn');
            if(generateBtn) generateBtn.addEventListener('click', handleGenerateStory);
            document.getElementById('saveBtn').addEventListener('click', handleFinalSubmit);
            document.getElementById('back-to-list-btn').addEventListener('click', () => showWorkbooksForTool(currentTool));
        }

        async function handleGenerateStory() {
            if (!geminiApiKey) { alert('AI ê¸°ëŠ¥ì— í•„ìš”í•œ API í‚¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
            const k1 = document.getElementById('keyword1').value.trim(), k2 = document.getElementById('keyword2').value.trim(), k3 = document.getElementById('keyword3').value.trim();
            if (!k1 || !k2 || !k3) { alert('ì„¸ ê°€ì§€ ë‹¨ì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            const prompt = `ì˜¤ëŠ˜ ë§Œë“  '${currentWorkbook.name}' ëª¨ë¸ì— ëŒ€í•œ ì´ì•¼ê¸°ì•¼. '${k1}', '${k2}', '${k3}' ë‹¨ì–´ë¥¼ ê¼­ ë„£ì–´ì„œ, ì´ˆë“±í•™ìƒì´ ì¢‹ì•„í•  ë§Œí•œ ì§§ê³  ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ 5ë¬¸ì¥ ë‚´ì™¸ë¡œ ë§Œë“¤ì–´ ì¤˜.`;
            const btn = document.getElementById('generateStoryBtn'), storyResult = document.getElementById('storyResult');
            btn.disabled = true; btn.querySelector('#btnText').textContent = 'AIê°€ ìƒê° ì¤‘...'; btn.querySelector('#btnSpinner').classList.remove('hidden');
            storyResult.textContent = 'AI ì¹œêµ¬ê°€ ì—´ì‹¬íˆ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message); }
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                storyResult.textContent = text || "ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì§€ ëª»í–ˆì–´ìš”.";
                saveStateToLocalStorage();
            } catch (error) {
                console.error("Gemini API Error:", error);
                storyResult.textContent = `ì´ì•¼ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. (ì˜¤ë¥˜: ${error.message})`;
            } finally {
                btn.disabled = false; btn.querySelector('#btnText').textContent = 'ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸° ë§Œë“¤ê¸°!'; btn.querySelector('#btnSpinner').classList.add('hidden');
            }
        }

        function initializeApp() {
            if (typeof google === 'undefined' || !google.script || !google.script.run) { setTimeout(initializeApp, 100); return; }
            google.script.run.withSuccessHandler(data => {
                if (data.error) { throw new Error(data.error); }
                allWorkbooks = data.workbooks; geminiApiKey = data.apiKey;
                showLoading(false); displayStartScreen();
            }).withFailureHandler(err => {
                console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", err); showLoading(false);
                alert('ì•±ì„ ì´ˆê¸°í™”í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }).getInitialData();
        }

        backToStartBtn.addEventListener('click', () => switchView('start-view'));
        window.onload = initializeApp;
    </script>
</body>
</html>
