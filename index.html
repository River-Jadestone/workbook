<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
        }
        .progress-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        /* ë¶€ë“œëŸ¬ìš´ í™”ë©´ ì „í™˜ íš¨ê³¼ */
        .view {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì°½ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        /* ì™„ë£Œëœ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .detail-task-item.completed {
            text-decoration: line-through;
            color: #6b7280;
        }
        .detail-task-item.completed .checkbox-icon {
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- 1. ì›Œí¬ë¶ ì„ íƒ í™”ë©´ -->
        <div id="workbook-selection-view" class="view" style="display: block;">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-black text-[#2c3e50]">ğŸš€ ì „ì²´ ì›Œí¬ë¶ ëª©ë¡</h1>
                <p class="text-lg text-[#34495e] mt-2 font-bold">í™•ì¸í•˜ê³  ì‹¶ì€ ì›Œí¬ë¶ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            </header>
            <main id="workbook-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì›Œí¬ë¶ ëª©ë¡ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </main>
        </div>

        <!-- 2. í•™ìƒ ëª©ë¡ í™”ë©´ -->
        <div id="student-list-view" class="view">
            <header class="relative flex items-center justify-center mb-10 py-4">
                <button id="back-to-selection-btn" class="absolute left-0 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    &larr; ëª©ë¡ìœ¼ë¡œ
                </button>
                <h1 id="list-title" class="text-2xl md:text-4xl font-black text-[#2c3e50] text-center"></h1>
            </header>
            <main class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">ì´ ì°¸ì—¬ í•™ìƒ ìˆ˜</h2>
                        <p id="totalStudents" class="text-5xl font-extrabold text-[#3498db]">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 class="text-xl font-bold text-gray-500">ì „ì²´ í‰ê·  ì§„í–‰ë¥ </h2>
                        <p id="averageProgress" class="text-5xl font-extrabold text-[#4ECDC4]">0%</p>
                    </div>
                </div>
                <div id="studentListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ í•™ìƒ ì¹´ë“œ ëª©ë¡ì´ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                </div>
            </main>
        </div>

        <!-- 3. í•™ìƒ ìƒì„¸ ì •ë³´ í™”ë©´ -->
        <div id="single-student-view" class="view">
             <header class="relative flex items-center justify-center mb-10 py-4">
                <button id="back-to-list-btn" class="absolute left-0 bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                    &larr; í•™ìƒ ëª©ë¡ìœ¼ë¡œ
                </button>
                <h1 id="detail-student-name" class="text-2xl md:text-4xl font-black text-[#2c3e50] text-center"></h1>
            </header>
            <main id="student-detail-content" class="space-y-8 max-w-4xl mx-auto">
                 <!-- í•™ìƒ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </main>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì°½ -->
    <div id="delete-confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
            <p id="delete-confirmation-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors">ì·¨ì†Œ</button>
                <button id="confirm-delete-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition-colors">ì‚­ì œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvLt0F8gSqe24Gf0xHHw25MfMirmV6er0",
            authDomain: "workbook-c77c1.firebaseapp.com",
            projectId: "workbook-c77c1",
            storageBucket: "workbook-c77c1.appspot.com",
            messagingSenderId: "763395615278",
            appId: "1:763395615278:web:8f245f9b328440f0a54dbf"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const workbooks = [
            { 
                id: 'snack-shop-workbook', 
                name: 'ğŸŒˆ ì•Œë¡ë‹¬ë¡ ìŠ¤ë‚µ ê°€ê²Œ ë§Œë“¤ê¸°',
                checklistItems: [
                    "ìŠ¤ë‚µ ê°€ê²Œ ë¡œë´‡ì„ ëšë”±ëšë”± ì¡°ë¦½í–ˆì–´ìš”.",
                    "ë‚´ ê°€ê²Œì˜ ê·œì¹™ì„ ì •í•˜ê³  ì½”ë”© ì•½ì†ì„ í–ˆì–´ìš”.",
                    "ìƒ‰ê¹”ì— ë§ì¶° ê³¼ìë¥¼ ì£¼ëŠ” ê¸°ë³¸ ì½”ë”©ì„ ì™„ì„±í–ˆì–´ìš”.",
                    "ë” ë©‹ì§„ ê¸°ëŠ¥ì„ ë§Œë“œëŠ” ë„ì „ ë¯¸ì…˜ì— ì„±ê³µí–ˆì–´ìš”!",
                    "AI ì¹œêµ¬ì™€ í•¨ê»˜ ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì—ˆì–´ìš”.",
                    "ì¹œêµ¬ë“¤ì—ê²Œ ë‚´ ìŠ¤ë‚µ ê°€ê²Œë¥¼ ë©‹ì§€ê²Œ ìë‘í–ˆì–´ìš”."
                ]
            },
        ];
        
        const workbookSelectionView = document.getElementById('workbook-selection-view');
        const studentListView = document.getElementById('student-list-view');
        const singleStudentView = document.getElementById('single-student-view');
        const workbookListContainer = document.getElementById('workbook-list');
        const studentListContainer = document.getElementById('studentListContainer');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const listTitle = document.getElementById('list-title');
        const detailStudentName = document.getElementById('detail-student-name');
        const studentDetailContent = document.getElementById('student-detail-content');
        const totalStudentsEl = document.getElementById('totalStudents');
        const averageProgressEl = document.getElementById('averageProgress');
        const deleteModal = document.getElementById('delete-confirmation-modal');
        const deleteConfirmationText = document.getElementById('delete-confirmation-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let currentSnapshotUnsubscribe = null;
        let currentWorkbook = null; 
        let studentIdToDelete = null;

        const showView = (viewToShow) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            viewToShow.style.display = 'block';
        };

        const showStudentDetails = (workbook) => {
            currentWorkbook = workbook;
            showView(studentListView);
            listTitle.textContent = workbook.name;
            studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
            totalStudentsEl.textContent = '0';
            averageProgressEl.textContent = '0%';

            const studentsColRef = collection(db, `artifacts/${workbook.id}/public/data/students`);
            
            if (currentSnapshotUnsubscribe) currentSnapshotUnsubscribe();
            currentSnapshotUnsubscribe = onSnapshot(studentsColRef, (snapshot) => {
                const studentsData = [];
                snapshot.forEach((doc) => studentsData.push([doc.id, doc.data()]));
                updateDashboard(studentsData);
            }, (error) => {
                console.error(`Error fetching data for ${workbook.id}:`, error);
                studentListContainer.innerHTML = `<p class="text-center md:col-span-2 lg:col-span-3 text-red-500">"${workbook.name}" ì›Œí¬ë¶ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            });
        };

        const createStudentCard = (studentId, studentData) => {
            const studentName = studentData.studentName || 'ì´ë¦„ ì—†ìŒ';
            const totalTasks = currentWorkbook.checklistItems.length;
            const completedCount = (studentData.completedTasks || []).filter(Boolean).length;
            const progress = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;

            const card = document.createElement('div');
            card.className = "bg-white rounded-2xl shadow-lg p-6 flex flex-col justify-between cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all";
            card.dataset.studentId = studentId;

            card.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-xl text-[#2c3e50] truncate">${studentName}</h3>
                        <p class="text-sm text-gray-400">ID: ${studentId.substring(0, 8)}...</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-600">ì§„í–‰ë¥ : ${Math.round(progress)}%</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-1">
                            <div class="bg-gradient-to-r from-[#3498db] to-[#4ECDC4] h-4 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
                <button data-id="${studentId}" data-name="${studentName}" class="delete-btn mt-6 w-full bg-red-100 text-red-700 font-bold py-2 px-3 rounded-lg hover:bg-red-200 transition-colors">ì‚­ì œ</button>
            `;
            return card;
        };
        
        const updateDashboard = (students) => {
            studentListContainer.innerHTML = '';
            let totalProgress = 0;
            
            if (students.length === 0) {
                studentListContainer.innerHTML = '<p class="text-center md:col-span-2 lg:col-span-3 text-gray-500">ì•„ì§ ì°¸ì—¬í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            students.sort((a, b) => (a[1].studentName || '').localeCompare(b[1].studentName || '', 'ko'));

            const studentDataMap = new Map(students);
            
            studentDataMap.forEach((data, id) => {
                const card = createStudentCard(id, data);
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                       showSingleStudentDetail(data);
                    }
                });
                studentListContainer.appendChild(card);
                
                const totalTasks = currentWorkbook.checklistItems.length;
                const completedCount = (data.completedTasks || []).filter(Boolean).length;
                totalProgress += totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
            });
            
            totalStudentsEl.textContent = students.length;
            const avgProgress = students.length > 0 ? totalProgress / students.length : 0;
            averageProgressEl.textContent = `${Math.round(avgProgress)}%`;
        };

        const showSingleStudentDetail = (studentData) => {
            detailStudentName.textContent = studentData.studentName || 'ì´ë¦„ ì—†ìŒ';
            
            let checklistHTML = '';
            currentWorkbook.checklistItems.forEach((itemText, index) => {
                const isCompleted = studentData.completedTasks?.[index] || false;
                checklistHTML += `
                    <li class="detail-task-item flex items-center p-3 bg-slate-100 rounded-lg ${isCompleted ? 'completed' : ''}">
                        <div class="checkbox-icon w-6 h-6 mr-4 flex-shrink-0 flex items-center justify-center font-bold">${isCompleted ? 'âœ”' : 'âœ–'}</div>
                        <span>${itemText}</span>
                    </li>
                `;
            });
            
            const story = (studentData.savedStory || 'ì•„ì§ ì´ì•¼ê¸°ê°€ ì—†ì–´ìš”.').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought1 = (studentData.savedThoughts?.[0] || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const thought2 = (studentData.savedThoughts?.[1] || '').replace(/</g, "&lt;").replace(/>/g, "&gt;");

            studentDetailContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">âœ… í™œë™ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
                    <ul class="space-y-3">${checklistHTML}</ul>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">ğŸš€ AI ì¹œêµ¬ê°€ ë§Œë“  ì´ì•¼ê¸°</h2>
                    <div class="p-4 bg-gray-100 rounded-md min-h-[100px] whitespace-pre-wrap">${story}</div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-[#2c3e50] mb-4">ğŸ¤” ìƒê° ë‚˜ëˆ„ê¸°</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-1">ì˜¤ëŠ˜ ë‚´ê°€ ë§Œë“  ìŠ¤ë‚µ ê°€ê²Œ ë¡œë´‡ì˜ ìµœê³ ë¡œ ë©‹ì§„ ì ì€ ë¬´ì—‡ì¸ê°€ìš”?</h3>
                            <p class="p-3 bg-gray-100 rounded-md min-h-[60px]">${thought1 || 'ì•„ì§ ì‘ì„±í•˜ì§€ ì•Šì•˜ì–´ìš”.'}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-1">ì´ ë©‹ì§„ ë¡œë´‡ì´ ìš°ë¦¬ ì§‘ì´ë‚˜ í•™êµì— ìˆë‹¤ë©´, ë¬´ì—‡ì„ ë„ì™€ì¤„ ìˆ˜ ìˆì„ê¹Œìš”?</h3>
                            <p class="p-3 bg-gray-100 rounded-md min-h-[60px]">${thought2 || 'ì•„ì§ ì‘ì„±í•˜ì§€ ì•Šì•˜ì–´ìš”.'}</p>
                        </div>
                    </div>
                </div>
            `;
            showView(singleStudentView);
        };
        
        const openDeleteModal = (studentId, studentName) => {
            studentIdToDelete = studentId;
            deleteConfirmationText.textContent = `'${studentName}' í•™ìƒì˜ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            deleteModal.classList.remove('hidden');
        };

        const closeDeleteModal = () => {
            studentIdToDelete = null;
            deleteModal.classList.add('hidden');
        };

        // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        
        workbookListContainer.innerHTML = '';
        workbooks.forEach(wb => {
            const wbCard = document.createElement('div');
            wbCard.className = "bg-white p-8 rounded-2xl shadow-lg text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300";
            wbCard.innerHTML = `<h2 class="text-2xl font-bold text-[#2c3e50]">${wb.name}</h2>`;
            wbCard.addEventListener('click', () => showStudentDetails(wb));
            workbookListContainer.appendChild(wbCard);
        });
        
        backToSelectionBtn.addEventListener('click', () => showView(workbookSelectionView));
        backToListBtn.addEventListener('click', () => showView(studentListView));

        studentListContainer.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const studentId = deleteButton.dataset.id;
                const studentName = deleteButton.dataset.name;
                openDeleteModal(studentId, studentName);
            }
        });

        cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            if (studentIdToDelete && currentWorkbook) {
                const docRef = doc(db, `artifacts/${currentWorkbook.id}/public/data/students`, studentIdToDelete);
                try {
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    closeDeleteModal();
                }
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));
            }
        });

    </script>
</body>
</html>
